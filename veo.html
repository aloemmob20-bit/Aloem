<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Veo2 Video Generator</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 text-white min-h-screen flex flex-col items-center justify-center p-6">
  <div class="w-full max-w-lg bg-gray-800 rounded-2xl shadow-xl p-6 space-y-4">
    <h1 class="text-2xl font-bold text-center">Follow TikTok : aloemTV</h1>

    <!-- Input API Key -->
    <div>
      <label class="block mb-1">API Key Google</label>
      <input id="apiKey" type="text" placeholder="Masukkan API Key"
        class="w-full px-3 py-2 rounded-lg bg-gray-700 text-white border border-gray-600">
    </div>

    <!-- Input Prompt -->
    <div>
      <label class="block mb-1">Prompt (Deskripsi Video)</label>
      <textarea id="prompt" rows="3" placeholder="Contoh: Pemandangan pantai indah dengan langit senja"
        class="w-full px-3 py-2 rounded-lg bg-gray-700 text-white border border-gray-600"></textarea>
    </div>

    <!-- Input Gambar -->
    <div>
      <label class="block mb-1">Tambahkan Gambar (opsional)</label>
      <input id="imageInput" type="file" accept="image/*"
        class="w-full text-sm text-gray-300 file:mr-4 file:py-2 file:px-4
        file:rounded-lg file:border-0 file:text-sm file:font-semibold
        file:bg-indigo-600 file:text-white hover:file:bg-indigo-700">
      <img id="imagePreview" class="mt-3 hidden rounded-lg shadow-md max-h-48 object-contain" />
    </div>

    <!-- Tombol Generate -->
    <button onclick="generateVideo()" 
      class="w-full bg-indigo-600 hover:bg-indigo-700 px-4 py-2 rounded-lg font-semibold">
      üöÄ Generate Video
    </button>

    <!-- Status -->
    <p id="status" class="text-sm text-gray-400 text-center"></p>

    <!-- Preview Video -->
    <div id="previewBox" class="hidden">
      <h2 class="text-lg font-bold mt-4 mb-2">Preview Video</h2>
      <video id="preview" class="w-full rounded-lg shadow-md" controls></video>
      <button id="downloadBtn" 
        class="mt-4 w-full bg-green-600 hover:bg-green-700 px-4 py-2 rounded-lg font-semibold">
        ‚¨áÔ∏è Download MP4
      </button>
    </div>
  </div>

  <script>
    let imageBase64 = null;

    // Preview Gambar
    document.getElementById("imageInput").addEventListener("change", function(event) {
      const file = event.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
          imageBase64 = e.target.result.split(",")[1]; // ambil base64 tanpa prefix
          const imgEl = document.getElementById("imagePreview");
          imgEl.src = e.target.result;
          imgEl.classList.remove("hidden");
        };
        reader.readAsDataURL(file);
      }
    });

    async function generateVideo() {
      const apiKey = document.getElementById("apiKey").value.trim();
      const prompt = document.getElementById("prompt").value.trim();
      const status = document.getElementById("status");
      const previewBox = document.getElementById("previewBox");
      const videoEl = document.getElementById("preview");
      const downloadBtn = document.getElementById("downloadBtn");

      if (!apiKey || !prompt) {
        alert("Isi API Key dan Prompt dulu!");
        return;
      }

      status.textContent = "‚è≥ Mengirim permintaan ke Veo2...";
      previewBox.classList.add("hidden");

      // Build request body
      let bodyData = {
        prompt: { text: prompt },
        aspectRatio: "9:16"
      };

      if (imageBase64) {
        bodyData.prompt.image = {
          mimeType: "image/png",
          data: imageBase64
        };
      }

      // 1. Request Video
      const res = await fetch(
        "https://generativelanguage.googleapis.com/v1beta/models/veo-2.0:generateVideo?key=" + apiKey,
        {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(bodyData)
        }
      );

      const operation = await res.json();
      if (operation.error) {
        status.textContent = "‚ùå Error: " + operation.error.message;
        return;
      }

      status.textContent = "‚è≥ Video sedang diproses... tunggu beberapa detik";

      // 2. Polling
      let opResult;
      while (true) {
        const check = await fetch("https://generativelanguage.googleapis.com/v1beta/" + operation.name + "?key=" + apiKey);
        opResult = await check.json();
        if (opResult.done) break;
        await new Promise(r => setTimeout(r, 5000));
      }

      // 3. Ambil URI video
      const fileUrl = opResult.response.generatedVideos[0].video.uri;

      // 4. Tampilkan preview
      videoEl.src = fileUrl;
      previewBox.classList.remove("hidden");
      status.textContent = "‚úÖ Video siap diputar & didownload";

      // 5. Tombol Download
      downloadBtn.onclick = async () => {
        const fileRes = await fetch(fileUrl);
        const blob = await fileRes.blob();
        const url = URL.createObjectURL(blob);

        const a = document.createElement("a");
        a.href = url;
        a.download = "video.mp4";
        a.click();
        URL.revokeObjectURL(url);
      };
    }
  </script>
</body>
</html>
