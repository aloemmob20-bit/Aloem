<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Veo 2 ‚Äì Image to Video (9:16)</title>
  <style>
    body { font-family: sans-serif; max-width: 600px; margin: auto; padding: 20px; }
    input, textarea, button, select { display: block; margin: 10px 0; width: 100%; padding: 8px; }
    video { width: 100%; margin-top: 20px; border: 1px solid #ccc; border-radius: 8px; }
    progress { width: 100%; height: 20px; margin-top: 10px; }
  </style>
</head>
<body>
  <h1>üé• Veo 2 ‚Äì Image ‚Üí Video</h1>
  <input id="apiKey" type="password" placeholder="Masukkan Google API Key">
  <input id="img" type="file" accept="image/*">
  <textarea id="prompt" rows="3" placeholder="Tulis deskripsi video..."></textarea>
  <select id="ratio">
    <option value="9:16">9:16 (default)</option>
    <option value="16:9">16:9</option>
    <option value="1:1">1:1</option>
  </select>
  <button id="gen">Generate Video</button>
  <progress id="pg" value="0" max="100" style="display:none"></progress>
  <p id="status"></p>
  <video id="out" controls></video>

  <script type="module">
    import { GoogleGenAI } from "https://esm.sh/@google/genai";

    const $ = id => document.getElementById(id);
    const sleep = ms => new Promise(r => setTimeout(r, ms));

    $("gen").addEventListener("click", async () => {
      const apiKey = $("apiKey").value.trim();
      const file = $("img").files[0];
      const prompt = $("prompt").value.trim();
      const ratio = $("ratio").value.trim() || "9:16";
      const status = $("status"), pg = $("pg"), videoEl = $("out");

      videoEl.removeAttribute("src"); videoEl.load();
      if (!apiKey) { alert("Masukkan API Key dulu"); return; }
      if (!file) { alert("Upload gambar dulu"); return; }
      if (!prompt) { alert("Isi prompt deskripsinya"); return; }

      // convert file ke base64
      const base64 = await new Promise((res, rej) => {
        const reader = new FileReader();
        reader.onload = () => res(reader.result.split(",")[1]);
        reader.onerror = rej;
        reader.readAsDataURL(file);
      });

      const ai = new GoogleGenAI({ apiKey });
      status.textContent = "Mengirim job ke Veo 2...";
      pg.style.display = "block"; pg.value = 10;

      try {
        let op = await ai.models.generateVideos({
          model: "veo-2.0-generate-001",
          prompt,
          image: { imageBytes: base64, mimeType: file.type },
          config: { aspectRatio: ratio }
        });

        let tries = 0;
        while (!op.done) {
          status.textContent = "Memproses... tunggu beberapa detik";
          await sleep(8000);
          op = await ai.operations.getVideosOperation({ operation: op });
          tries++;
          pg.value = Math.min(90, 10 + tries * 5);
        }

        const fileRef = op.response.generatedVideos?.[0]?.video;
        if (!fileRef) throw new Error("Tidak ada video dalam respons");

        status.textContent = "Mengunduh video...";
        pg.value = 95;

        const fileMeta = await ai.files.download({ file: fileRef });
        const blob = new Blob([fileMeta.video.videoBytes], { type: "video/mp4" });
        const url = URL.createObjectURL(blob);

        // tampilkan video di halaman
        videoEl.src = url; 
        videoEl.play().catch(() => {});

        // buat link download
        const a = document.createElement("a");
        a.href = url;
        a.download = "veo2-video.mp4"; // pastikan ada ekstensi
        document.body.appendChild(a);

        // cek apakah browser support atribut download
        if (typeof a.download !== "undefined") {
          a.click();
          document.body.removeChild(a);
        } else {
          // fallback Safari iOS/macOS
          window.open(url, "_blank");
        }

        status.textContent = "‚úÖ Selesai! Video sudah tersedia.";
        pg.value = 100; setTimeout(() => pg.style.display = "none", 1200);

      } catch (e) {
        console.error(e);
        status.textContent = "‚ùå Error: " + (e.message || e);
        pg.style.display = "none";
      }
    });
  </script>
</body>
</html>
